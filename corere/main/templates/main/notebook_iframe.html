{% extends "main/layout_full.html" %}
{% block content %}
{% comment %} This way of showing the notebook may fail if the notebook finishes at the same time this page is loaded {% endcomment %}
<iframe src="{{notebook_url}}" title="notebook" id="notebook_iframe" {% if wt_launching %} style="display:none;" {% endif %}></iframe>

<form id="file_note_nested_form" action="" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="submit" name="back" value="Back">
    <input type="button" name="launch" value="Launch External" onclick="window.open('/manuscript/{{manuscript_id}}/notebook/')">
    <input type="submit" name="submit" value="Submit" onClick="return confirm('This submission will be handed off to the editor, and then the curation team. Is that ok?');"> 
</form>

{% if wt_launching %}
<div id="logdiv">

</div>

<script type="text/javascript">
    var last_response_len = false;
    $.ajax('../wtstream/', {
        xhrFields: {
            onprogress: function(e)
            {                
                $('#logdiv').html(e.currentTarget.response)
            }
        }
    })
    .done(function(data)
    {
        //TODO: This isn't actually getting the right url. Sample:
        //inder_Url: https:/tmp-uwewoviafcaj.stage.wholetale.org/?token=0d9d54f95c894035bb31d1d3131c815d
        binder_url= $('#logdiv').html().substring($('#logdiv').html().indexOf('Binder_Url: ')+12)
        console.log(binder_url)

        //TODO: Probably need to hide/show buttons as well?
        var notebookiframe = document.getElementById("notebook_iframe");
        if(notebookiframe) {
            notebookiframe.src = binder_url
            notebookiframe.style.display = 'block';
        }
    })
    .fail(function(data)
    {
        console.log('Error: ', data);
    });
    console.log('Request Sent');
</script>
{% endif %}

{% endblock content %}