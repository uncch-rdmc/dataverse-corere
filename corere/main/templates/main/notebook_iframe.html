{% extends "main/layout_full.html" %}
{% block content %}
{% load crispy_forms_tags %}
{% comment %} This way of showing the notebook may fail if the notebook finishes at the same time this page is loaded {% endcomment %}

{%comment%} Don't forget to re-add the removed wt_loaded bits. Also the correct wtstream. {% endcomment %}
{% include "main/page_title.html" %}
<iframe src="{{notebook_url}}" title="notebook" id="notebook_iframe" {% if wt_launching %} style="display:none;" {% endif %} ></iframe>

<form action="" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div id="notebook_issue_div" style="display:none;">
        {% crispy form helper %}
    </div>
    <input id="file_note_form_back" type="submit" name="back" value="Back" style="display:none;">
    {% if not read_only %}
        <input id="file_note_form_launch" type="button" name="launch" value="Launch External" style="display:none;">
        <input id="file_note_form_submit" type="submit" name="submit" value="Continue" style="display:none;"> 
        <input id="file_note_form_download" type="button" name="Download" value="Download Container Contents" style="display:none;" onclick="window.open('../wtdownloadall/')"> 
        <!-- {% if skip_edition %}
            <input id="file_note_form_submit" type="submit" name="submit" value="Submit" onClick="return confirm('This submission will be handed off to the curation team. Is that ok?');" style="display:none;"> 
        {% else %}
            <input id="file_note_form_submit" type="submit" name="submit" value="Submit" onClick="return confirm('This submission will be handed off to the editor, and then the curation team. Is that ok?');" style="display:none;"> 
        {% endif %}
             -->
        <input id="file_note_form_issues" type="button" name="submit" value="It isn't working" onClick="alert('We are sorry to hear you are having issues running your container. Please enter info about the issues you ran into in the text box above the button clicked, and then click submit.'); show_issues_form()" style="display:none;"> 

    {% endif %}
</form>

{% if wt_launching %}
<div id="logandbuttondiv" class="rounded border" style="padding:10px; height: 338px; ">
    <h5>Container Launch Status:</h5>
    <div id="logdiv" class="rounded border" style="height:240px; overflow: scroll; padding-left:10px;">

    </div>
    <form><button id="show_notebook_button" type="button" class="button btn-secondary btn-sm" onclick="show_iframe()" style="display:none; margin-top:10px;">Display Notebook</button></form>       
</div>

<script type="text/javascript">
    var last_response_len = false;
    container_url = "";
    $.ajax('../wtstream/', {
        xhrFields: {
            onprogress: function(e)
            {          
                var logdiv = $('#logdiv');      
                logdiv.html(e.currentTarget.response);
                logdiv.scrollTop(logdiv[0].scrollHeight);
                //{% comment %}could detect scrolled https://stackoverflow.com/questions/18614301/ {% endcomment %}
            }
        }
    })
    .done(function(data)
    {
        container_url= $('#logdiv').html().substring($('#logdiv').html().indexOf('Container URL: ')+15)
        console.log(container_url)

        var formlaunch = document.getElementById("file_note_form_launch");
        if(formlaunch) {
            formlaunch.onclick = function() {window.open(container_url)};
        }

        var show_notebook_button = document.getElementById("show_notebook_button");
        if(show_notebook_button) {
            show_notebook_button.style.display = 'block';
        }
    })
    .fail(function(data)
    {
        console.log('Error: ', data);
    });
    console.log('Request Sent');

    function show_iframe() {
        var notebookiframe = document.getElementById("notebook_iframe");
        if(notebookiframe) {
            notebookiframe.src = container_url
            notebookiframe.style.display = 'block';
        }
        var formlaunch = document.getElementById("file_note_form_launch");
        if(formlaunch) {
            formlaunch.style.display = '';
        }
        {% if is_author %}
        var formback = document.getElementById("file_note_form_back");
        if(formback) {
            formback.style.display = '';
        }
        var formsubmit = document.getElementById("file_note_form_submit");
        if(formsubmit) {
            formsubmit.style.display = '';
        }
        var formdownload = document.getElementById("file_note_form_download");
        if(formdownload) {
            formdownload.style.display = '';
        }
        var formissues = document.getElementById("file_note_form_issues");
        if(formissues) {
            formissues.style.display = '';
        }
        {% endif %}
        var logandbuttondiv = document.getElementById("logandbuttondiv");
        if(logandbuttondiv) {
            logandbuttondiv.style.display = 'none';
        }
    }
</script>
{% else %}
    <script>
        var formlaunch = document.getElementById("file_note_form_launch");
        if(formlaunch) {
            var notebookiframe = document.getElementById("notebook_iframe");
            if(notebookiframe) {
                console.log(notebookiframe.src)
                formlaunch.onclick = function() {window.open(notebookiframe.src)};
            }
            formlaunch.style.display = '';
        }
    </script>
    {% if is_author %}
    <script>
        var formback = document.getElementById("file_note_form_back");
        if(formback) {
            formback.style.display = '';
        }
        var formsubmit = document.getElementById("file_note_form_submit");
        if(formsubmit) {
            formsubmit.style.display = '';
        }
        var formdownload = document.getElementById("file_note_form_download");
        if(formdownload) {
            formdownload.style.display = '';
        }
        var formissues = document.getElementById("file_note_form_issues");
        if(formissues) {
            formissues.style.display = '';
        }
    </script>
    {% endif %}
{% endif %}
<!-- <br>
<div id="notebook_issue_div" style="display:none;">
    <form id="submission_notebook_issues_form" action="" method="post" enctype="multipart/form-data" >
        {% csrf_token %}
        {% crispy form helper %}
    </form>
</div> -->
<script>
    function show_issues_form() {
        var notebook_issue_div = document.getElementById("notebook_issue_div");
        if(notebook_issue_div) {
            notebook_issue_div.style.display = 'block';
        }
    }
</script>
{% endblock content %}
