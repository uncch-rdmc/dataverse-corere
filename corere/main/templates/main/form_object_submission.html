{% extends "main/layout_fixed.html" %}
{% block content %}
{% load concat %}
{% load auth_extras %} {% comment %} added this for our manuscript form {% endcomment %}
{% load crispy_forms_tags %}

{% load static %}
<script src="{% static 'main/jquery.formset.20201005.coreremod.js' %}"></script>
<script type="text/javascript">
    $(function () {
        var launch_issues_text_box = document.getElementById('id_launch_issues');
        if (launch_issues_text_box && launch_issues_text_box.value.trim() == "") {
            var launch_issues_text_box_div = document.getElementById('div_id_launch_issues');
            launch_issues_text_box_div.style.display = "none";
        }
    })
</script>

{% include "main/page_header.html" %}    
<form id="generic_object_form" action="" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {% crispy form helper %}

        {% comment %} The commented out links in this review block should be re-enabled with logic to ensure they only show when the option is available 
        The launch container link remains because if you are in review you are able to launch a container {% endcomment %}
        {% if verification_formset or curation_formset or edition_formset and s_status != "rejected_editor" %}
        <h5 class="title-text">Info</h5>
        <div class="accordion" id="manuscriptAccordionPanels">
            <div class="accordion-item">
                <h2 class="accordion-header" id="panelsStayOpen-headingOne">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="false" aria-controls="panelsStayOpen-collapseOne" aria-label="Show/hide manuscript files">
                    Manuscript Metadata
                </button>
                </h2>
                <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse" data-bs-parent="#manuscriptAccordionPanels" aria-labelledby="panelsStayOpen-headingOne">
                <div class="accordion-body">                
                    {{ manuscript_metadata_html|safe}}
                    {% comment %} <a href="/manuscript/{{parent_id}}/edit/" target="_blank">Edit Metadata</a> {% endcomment %}
                </div>
                </div>
            </div>
            <div class="accordion-item">
            <h2 class="accordion-header" id="panelsStayOpen-headingTwo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo" aria-label="Show/hide manuscript files">
                Manuscript Files
                </button>
            </h2>
            <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse" data-bs-parent="#manuscriptAccordionPanels" aria-labelledby="panelsStayOpen-headingTwo">
                <div class="accordion-body">                
                    <div id="m_files_list_holder">
                        {% include "file_datatable/file_datatable.html" with obj_id=parent_id obj_type='manuscript' read_only=True file_url_base=m_file_url_base%}
                        {% comment %} <a href="/manuscript/{{parent_id}}/uploadfiles/" target="_blank">Edit Files</a> {% endcomment %}
                    </div>
                </div>
            </div>
            </div>
            <div class="accordion-item">
            <h2 class="accordion-header" id="panelsStayOpen-headingThree">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false" aria-controls="panelsStayOpen-collapseThree" aria-label="Show/hide list of submissions">
                Submission Files
                </button>
            </h2>
            <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse" data-bs-parent="#manuscriptAccordionPanels" aria-labelledby="panelsStayOpen-headingThree">
                <div class="accordion-body">    
                    <div id="s_files_list_holder">
                        {% include "file_datatable/file_datatable.html" with obj_id=object_id obj_type='submission' read_only=True file_url_base=s_file_url_base%}
                        {% comment %} <a href="../uploadfiles/" target="_blank">Edit Files</a> {% endcomment %}
                        <a href="../notebook/" target="_blank">Launch Container</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <hr>
    {% endif %}

    {% if obj_type != 'manuscript' %} {% comment %} and note_formset and note_helper | This may lead to view mistakes failing silently {% endcomment %}
        {% include "main/note_list.html" %} 
        <hr>   
    {% endif %}

    {% if verification_formset %}
        <h5 class="title-text">Verifier Review</h5>
        {{ verification_formset.non_form_errors }}
        {% crispy verification_formset helper %}
        <hr>
    {% endif %}
    {% if curation_formset %}
        <h5 class="title-text">Curator Review</h5>
        {{ curation_formset.non_form_errors }}
        {% crispy curation_formset helper %}
        {% if submission_editor_date_formset %}
            <!-- <h5 class="title-text">Curator Review</h5> -->
            {{ submission_editor_date_formset.non_form_errors }}
            {% crispy submission_editor_date_formset helper %}
        {% endif %}
        <hr>
    {% endif %}

    {% if edition_formset %}
        <h5 class="title-text">Editor Review</h5>
        {{ edition_formset.non_form_errors }}
        {% crispy edition_formset helper %}
        <hr>
    {% endif %}

    {% comment %} Putting read_only checks around every submit was done to make the view page show up right even when you are a role that could edit at that point {% endcomment %}
    {%comment%} here we need to add an option for when we are in "read only" to show the submit button still {%endcomment%}
    {% if read_only or not can_progress %}
        <input type=button value="Home" title="Return to manuscript landing page" aria-label="Return to manuscript landing page" onClick="location.href='/manuscript/{{parent_id}}/';">
        <input type="submit" value="Save" title="Save note changes for this submission of data/code" aria-label="Save note changes for this submission of data/code">
    {% elif verification_formset %}
        <input type=button value="Home" title="Return to manuscript landing page" aria-label="Return to manuscript landing page" onClick="location.href='/manuscript/{{parent_id}}/';">
        <input type="submit" value="Save" title="Save note changes for this submission of data/code" aria-label="Save note changes for this submission of data/code" onclick="return confirm('This will save the current state of the form, but you will need to return to this page to submit your review.');">
        <input type="submit" name="submit_progress_verification" value="Submit and Progress" title="Save note changes for this submission of data/code, and hand off your review" aria-label="Save note changes for this submission of data/code, and hand off your review" onclick="return confirm('Once you hand off this form, editing the status will be locked. Is this ok?');">
    {% elif curation_formset %}
        {% comment %}cases to add: curation issues and no verification, curation issues and verification, no curation issues and no verification, no curation issues and no verification{%endcomment%}
        <input type=button value="Home" title="Return to manuscript landing page" aria-label="Return to manuscript landing page" onClick="location.href='/manuscript/{{parent_id}}/';">
        <input type="submit" value="Save" title="Save note changes for this submission of data/code" aria-label="Save note changes for this submission of data/code" onclick="return confirm('This will save the current state of the form, but you will need to return to this page to submit your review.');">
        <input type="submit" name="submit_progress_curation" value="Submit and Progress" title="Save note changes for this submission of data/code, and hand off your review" aria-label="Save note changes for this submission of data/code, and hand off your review" id="submit_progress_curation_button" >

        <script>
            var submit_button = document.getElementById('submit_progress_curation_button');
            submit_button.onclick = function() {
                var nv_checkbox = document.getElementById('id_curation_formset-0-needs_verification');
                var cur_status = document.getElementById('id_curation_formset-0-_status'); //cur_status.value
                console.log(cur_status.value)
                if(nv_checkbox.checked) {
                    if(cur_status.value == 'no_issues'){
                        return confirm('You have approved this submission, and review will be handed to the verifiers. Is this ok?');
                    } else {
                        return confirm('You have not approved this submission, but review will still be handed to the verifiers. Is this ok?');
                    }
                } else {
                    if(cur_status.value == 'no_issues'){
                        return confirm('You have approved this submission, but have not selected verification. After this the manuscript will be ready for completion. Is this ok?');
                    } else {
                        return confirm('You have not approved this submission and have not selected verification. After this the editor will be able to create another submission. Is this ok?');
                    }
                }
            };

        </script>
    {% elif create %}
        <!-- <input type=button value="Home" onClick="location.href='/manuscript/{{parent_id}}/';"> -->
        <input type="submit" name="back_save" value="Back" title="" aria-label="">
        <input type="submit" name="submit_continue" value="Create and Continue" title="" aria-label="">
    {% elif s_status == "new" or s_status == "rejected_editor"%}
        <!-- <input type=button value="Home" onClick="val = confirm('You must complete these forms to create your submission. Are you sure you\'d like to return home?'); if(val){location.href='/manuscript/{{parent_id}}/';}"> -->
        <input type="submit" name="back_save" value="Back" title="Save changes and return to previous page" aria-label="Save changes and return to previous page">
        {% if skip_docker %}
            <input type="submit" name="submit_continue" value="Submit" title="Save note changes for this submission of data/code, and hand off to the editor" aria-label="Save note changes for this submission of data/code, and hand off to the editor" onclick="return confirm('Docker is disabled for this installation, so by clicking submit this submission will be handed off to the editor, and then the curation team. Is that ok?');">
        {% elif not containerized %}
            <input type="submit" name="submit_continue" value="Submit" title="Save note changes for this submission of data/code, and hand off to the editor" aria-label="Save note changes for this submission of data/code, and hand off to the editor" onclick="return confirm('This submission will be handed off to the editor, and then the curation team. Is that ok?');">
        {% else %}
            <input type="submit" name="submit_continue" value="Launch Container" title="Launch container for this submission of data/code" aria-label="Launch container for this submission of data/code">
        {% endif %}
    {% elif edition_formset %}
        <input type=button value="Home" title="Return to manuscript landing page" aria-label="Return to manuscript landing page" onClick="location.href='/manuscript/{{parent_id}}/';">
        <input type="submit" name="submit" value="Save" title="Save note changes for this submission of data/code" aria-label="Save note changes for this submission of data/code" onclick="return confirm('This will save the current state of the form, but you will need to return to this page to submit your review.');">
        <input type="submit" name="submit_progress_edition" id="submit_progress_edition_button" value="Submit and Progress" title="Save note changes for this submission of data/code, and hand off to the curation team" aria-label="Save note changes for this submission of data/code, and hand off to the curation team" onclick="return confirm('Once you hand off this form, editing will be locked. Is this ok?');">
    {% else %}
        {% comment %} <input type="submit" name="submit_progress_submission" value="Submit and Progress" onclick="return confirm('Once you hand off this form, editing will be locked. Is this ok?');"> {% endcomment %}
        <!-- <input type=button value="Home" onClick="location.href='/manuscript/{{parent_id}}/';"> -->
        <input type="submit" name="submit_continue" value="Save" title="Save note changes for this submission of data/code" aria-label="Save note changes for this submission of data/code">
    {% endif %}
</form>

{% if obj_type != 'manuscript' %}
{% comment %} WHY ISN'T THIS IN note_list.html {% endcomment%}
<script>
    {% comment %} 
    // Goes through each note and checks if the author is our user. If not, disables the delete checkbox
    // We do this before the other script to remove the delete option from new notes.
    // 
    // We also pass in whether the user is a curator and keep delete checkbox if so.
    // Technically in the backend we use a perm on each note but since we always assign that perm to curators this is a way around having to pass all that info
    {% endcomment %}

    if('False' == '{{is_manu_curator}}')
        for( let elem of document.getElementById('note_table').lastElementChild.childNodes){
            if(elem.tagName == 'TR') {
                if(elem.firstElementChild.tagName == 'TD'){
                    creator_selectbox = elem.firstElementChild.firstElementChild.firstElementChild

                    if(creator_selectbox.options[creator_selectbox.selectedIndex].text != '{{ user.get_username }}') {
                        for(let celem of elem.childNodes) {
                            if(celem.tagName == 'TD') {
                                if(celem.id.endsWith('DELETE')) {
                                    celem.firstElementChild.firstElementChild.style.display = 'none'
                                }
                            }
                        }
                    }
                }
            }
        }

    {% comment %}
    // Gets the last note tr, and from that sets the display of the creator dropdown to the user.get_username
    // This was required to set the field to be the username. 
    // Setting the selection on the backend conflicts with disabling the field, and hacking validation was a pain/unsafe.
    // That being said, this is pretty brittle as well.
    {% endcomment %}

    var lastTr = document.getElementById('note_table').lastElementChild.lastElementChild;
    lastTr.firstElementChild.firstElementChild.firstElementChild.firstElementChild.textContent='{{ user.get_username }}'

    
</script>
{% endif %}

{% endblock content %}